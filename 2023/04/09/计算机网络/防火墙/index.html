<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>防火墙 |  学海无涯</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?b1b5dee3bb1719c8a439f8070118dc80";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


      <!-- <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script> -->
      <link href="https://cdn.bootcdn.net/ajax/libs/sweetalert2/11.7.3/sweetalert2.min.css" rel="stylesheet">
      <script src="https://cdn.bootcdn.net/ajax/libs/sweetalert2/11.7.3/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-计算机网络/防火墙"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  防火墙
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/" class="article-date">
  <time datetime="2023-04-09T11:51:22.000Z" itemprop="datePublished">2023-04-09</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">7k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">24 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>防火墙是一种安全设备，保护一个网络区域免受另一个网络区域的攻击和入侵，通常被部署在网络边界，例如：企业互联网出口。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/1.png" class="">

<p>简单讲防火墙作为网络中的设备，它的作用也是对网络起到安全保护的作用，对进出网络的流量进行安全管理，保证内网的安全性。</p>
<h1 id="防火墙分类"><a href="#防火墙分类" class="headerlink" title="防火墙分类"></a>防火墙分类</h1><p>按照硬件形态，防火墙可以分为盒式防火墙、框式防护墙。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2.png" class="">

<p>按照软硬件区分：防火墙可以分为软件防火墙和硬件防火墙。软件防火墙又可分为个人防火墙和网关防火墙。</p>
<p>按照防火墙技术原理：防火墙可以分为包过滤防火墙、状态检测防火墙，AI 防火墙。</p>
<h2 id="软件防火墙"><a href="#软件防火墙" class="headerlink" title="软件防火墙"></a>软件防火墙</h2><h3 id="个人防火墙"><a href="#个人防火墙" class="headerlink" title="个人防火墙"></a>个人防火墙</h3><p>个人防火墙运行在 PC 上，用于监控 PC 和外网的通信信息。在 Windows 操作系统中集成了 Windows 防火墙。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-1.png" class="">

<p>杀毒软件产品厂家的个人防火墙一般包含在安全软件套件里。</p>
<table>
<thead>
<tr>
<th align="center">个人防火墙产品的功能</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">确认连接请求</td>
<td align="center">向用户确认是否阻止特定的连接请求</td>
</tr>
<tr>
<td align="center">安全日志</td>
<td align="center">根据需要生成安全日志，记录 PC 正常连接与错误连接的信息。在做故障分析时，日志起到了很大的作用</td>
</tr>
<tr>
<td align="center">反病毒功能</td>
<td align="center">阻止 PC 接收病毒和蠕虫信息</td>
</tr>
<tr>
<td align="center">反间谍功能</td>
<td align="center">阻止 PC 接收间谍软件或程序的通信</td>
</tr>
<tr>
<td align="center">个人信息保护功能</td>
<td align="center">设置保护策略，防止个人信息被窃取、浏览恶意网站以及钓鱼诈骗等</td>
</tr>
</tbody></table>
<h3 id="网关防火墙"><a href="#网关防火墙" class="headerlink" title="网关防火墙"></a>网关防火墙</h3><p>在网络中的网关上配置防火墙的功能，能对网络中的流量进行策略控制，这就是网关防火墙。</p>
<p>网关防火墙分为两种，一种是在 Windows、Linux 等操作系统上安装并运行防火墙软件的软件网关防火墙，另一种是使用专用设备的硬件网关防火墙。</p>
<p>个人防火墙主要监控 PC 的通信流量，网关防火墙是监控网络中所有终端的通信流量，在网关处进行策略控制。</p>
<table>
<thead>
<tr>
<th align="center">区别</th>
<th align="center">个人防火墙</th>
<th align="center">网关防火墙</th>
</tr>
</thead>
<tbody><tr>
<td align="center">安装位置</td>
<td align="center">用户的 PC 上</td>
<td align="center">Windows或Linux等服务器上</td>
</tr>
<tr>
<td align="center">网络中的位置</td>
<td align="center">终端</td>
<td align="center">网关</td>
</tr>
<tr>
<td align="center">安装监控对象</td>
<td align="center">流入终端的流量</td>
<td align="center">经过网关的流量</td>
</tr>
<tr>
<td align="center">加密通信</td>
<td align="center">在终端上解密后检查</td>
<td align="center">不能检查</td>
</tr>
<tr>
<td align="center">压缩文件检查</td>
<td align="center">解压后检查</td>
<td align="center">对解压方式、解压基本有限制</td>
</tr>
<tr>
<td align="center">口令文件检查</td>
<td align="center">输入口令后解压检查</td>
<td align="center">不能检查</td>
</tr>
</tbody></table>
<h2 id="硬件防火墙"><a href="#硬件防火墙" class="headerlink" title="硬件防火墙"></a>硬件防火墙</h2><p>通过硬件设备实现的防火墙叫做硬件防火墙，外形跟路由器相似，接口类型通常有千兆网口、万兆光口。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-2.png" class="">

<h1 id="防火墙技术类型"><a href="#防火墙技术类型" class="headerlink" title="防火墙技术类型"></a>防火墙技术类型</h1><p>防火墙在网络边界判断允许进行的通信和不允许的通信作为其判断依据的技术类型的演进：</p>
<ul>
<li>分组过滤型：没有防火墙设备时，可以由路由器实现。根据网络中的传输的 IP 分组头部和 TCP&#x2F;IP 分组头部，获得源 IP 地址和端口号、目的 IP 地址和端口号，以这些信息作为过滤条件，决定是否转发这个分组。分组过滤会用到访问控制列表。</li>
<li>应用网关型：不以分组为单位进行通信过滤，而是特定的应用程序会话。</li>
<li>电路层网关型：在传输层进行连接中继，也就是第四层代理，通过 SOCKS 协议实现。内网终端连接外部网络时，终端与网关建立 TCP 连接，网关和外部服务器建立新的 TCP 连接。使用电路层网关，不用设置安全认证端口和 NAT，就可以让私有地址的内网终端访问外部网络。</li>
<li>状态检测型：动态分组过滤的一种，通过检测 TCP 的连接状态阻挡来路不明的分组，简称 SPI。可以抵抗下面类型的攻击：伪装 IP 地址或端口，发送附带 TCP 的 RST 或 FIN 标志位的分组，随意终止正常通信的攻击；在允许通信的范围内发送附带 TCP 的 ACK 标志位的分组，从而入侵内部网络；在 FTP 通信时，无论是否建立控制连接，都会创建数据连接进而入侵内部网络</li>
<li>新一代防火墙：根据上面的所有信息执行安全策略来进行防御，不仅根据端口号或协议号识别应用程序，还根据 IP 地址识别用户信息</li>
</ul>
<h2 id="代理服务器"><a href="#代理服务器" class="headerlink" title="代理服务器"></a>代理服务器</h2><p>代理服务器是应用网关防火墙的一种。假设客户端和 HTTP 服务器通信时，客户端发送请求报文时，代理服务器会替代客户端向 HTTP 服务器发送请求；HTTP 服务器回复响应报文时，代理服务器会代替 HTTP 服务器向客户端回复。对于客户端来说，代理服务器就是 HTTP 服务器。客户端和代理服务器、代理服务器和 HTTP 服务器分别建立两个会话。</p>
<p>从客户端收到的请求报文、从服务器收到响应报文，代理服务器都会在应用层进行检查，如果有异常就放弃通信或发送出错信息。</p>
<p>由于代理服务器是会话的起点，对互联网的服务器来说，是看不到客户端的 IP 地址。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-3.png" class="">

<p>报文过滤防火墙是以 IP 或 TCP&#x2F;UDP 为对象，判断是否允许通信。而应用网关防火墙是以应用程序为对象，也就是将 FTP、HTTP、Telnet、DNS 等为对象进行判断。</p>
<h1 id="防火墙的接口模式"><a href="#防火墙的接口模式" class="headerlink" title="防火墙的接口模式"></a>防火墙的接口模式</h1><p>防火墙有四种接口模式，分别是 L3 模式、L2 模式、L1 模式和 TAP 模式。</p>
<table>
<thead>
<tr>
<th align="center">接口模式</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">L3 模式</td>
<td align="center">也叫做 NAT 模式，和路由器接口一样，是拥有 IP 地址的接口。使用路由选择、NAT 以及连接 IPSec VPN 或 SSL VPN 时，必须使用 L3 模式接口。接口可配置静态 IP 地址，也可通过 PPPoE、DHCP动态获取 IP 地址</td>
</tr>
<tr>
<td align="center">L2 模式</td>
<td align="center">也叫做透传模式或透明模式，和交换机一样，是进行交接的接口。进行 IP 地址分配时，需要使用 VLAN</td>
</tr>
<tr>
<td align="center">L1 模式</td>
<td align="center">也叫做虚拟线缆模式。把两个接口组成一组，流量在一个接口输入，在另一个接口输出。这种模式下无法进行路由和桥接</td>
</tr>
<tr>
<td align="center">TAP 模式</td>
<td align="center">与交换机镜像端口连接的模式。对交换机的数据帧进行检测。由于不是串联，无法阻止非法通信</td>
</tr>
</tbody></table>
<p>L1 ~ L3 模式是将防火墙进行串连，TAP 模式是防火墙进行旁挂。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-4.png" class="">

<h1 id="防火墙能防范的威胁"><a href="#防火墙能防范的威胁" class="headerlink" title="防火墙能防范的威胁"></a>防火墙能防范的威胁</h1><ul>
<li>窃听：通过窃听网络数据获取银行卡号、密码等重要信息<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-5.png" class=""></li>
<li>篡改：将网站主页、邮件等通信内容恶意修改<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-6.png" class=""></li>
<li>破坏：通过电脑病毒或DoS攻击等破坏系统的正常工作<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-7.png" class=""></li>
<li>冒充：冒充他人发送邮件，对接收方进行钓鱼、诈骗等行为<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-8.png" class=""></li>
<li>信息泄露：电脑或服务器上的重要信息或文档泄露<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-9.png" class=""></li>
<li>攻击跳板：作为病毒部署或DoS攻击的跳板<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-10.png" class=""></li>
<li>垃圾邮件：以营利为目的发送大量邮件</li>
</ul>
<h1 id="防火墙功能"><a href="#防火墙功能" class="headerlink" title="防火墙功能"></a>防火墙功能</h1><p>防火墙常见的功能有：会话管理、报文结构解析、安全区域、安全策略、NAT、VPN、DoS 防御、报文攻击防御、内容扫描、监控和报告、报文抓包。</p>
<h2 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a>会话管理</h2><p>会话是两个终端系统之间的逻辑连接，从开始到结束的通信过程。</p>
<p>在 TCP 中，客户端和服务器通信，使用 3 次握手建立 1 个 TCP 连接，客户端发送请求（ request ），服务器进行回应（ response ），直至结束的过程就是进行了 1 个会话通信。</p>
<p>在 UDP 中，客户端和服务器的源端口和目的端口一致，之后的一系列通信都叫做会话。</p>
<p>在 ICMP 中，Echo request 和对应的 Echo reply 组成 1 个会话。</p>
<p>数据流是一组有序，有起点和终点的数据序列。一个会话有两个数据流（ flow ）：一个是 “ 客户端到服务器 ”（ client to server ），另一个是 “ 服务器到客户端 ”（ server to client ）。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-11.png" class="">

<h2 id="TCP-连接管理"><a href="#TCP-连接管理" class="headerlink" title="TCP 连接管理"></a>TCP 连接管理</h2><p>在数据通信前，客户端发送一个 SYN 包作为建立连接的请求。如果服务器发来回应，则认为可以开始数据通信。如果未收到服务器的回应，就不会进行数据通信。在通信结束时，会使用 FIN 包进行断开连接的处理。</p>
<p>SYN 包和 FIN 包是通过 TCP 头部的控制字段来管理 TCP 连接。一个连接的建立与断开，正常过程至少需要来回发送 7 个包才能完成。建立一个 TCP 连接需要发送 3 个包，这个过程叫作三次握手。断开一个 TCP 连接需要发送 4 个包，这个过程也称作四次挥手。创建一个 TCP 连接，会产生一个 32 位随机序列号，因为每一个新的连接使用一个新的随机序列号。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-12.png" class="">

<ul>
<li>SYN 检查<br>TCP 会话开始时，客户端会发送一个 SYN 消息。如果没有会话信息，或尚未建立会话，即非 SYN 消息的 TCP 数据段到达防火墙，防火墙会当做非法消息而丢弃。</li>
<li>ACK 检查<br>通过对 SYN-ACK 的 ACK 消息检查，确认进行中的 3 次握手是否是非法尝试，防范 SYN Flood 攻击。</li>
<li>重复数据段检查<br>防火墙收到重复数据段，也就是序列号相同的 TCP 数据段，可以选择接收或者丢弃。</li>
<li>窗口检查<br>防火墙可以检测 TCP 头部的序列号和滑动窗口大小，拦截超过滑动窗口容量数据的序列号。</li>
<li>数据段重组<br>防火墙可以验证 TCP 数据段序列号是否完整。</li>
</ul>
<h2 id="会话建立的处理"><a href="#会话建立的处理" class="headerlink" title="会话建立的处理"></a>会话建立的处理</h2><ol>
<li>防火墙收到报文后，首先检查会话表，确认是否有相同的会话。如果有相同会话，那么会禁止会话建立，确保会话都是唯一的。</li>
<li>如果是不同会话，那么检查报文，通常是查看路由表或 MAC 地址表来确定转发路径。如果可以转发，就确定对应的转发出接口和目的网段。如果不能转发，就丢弃这个数据。</li>
<li>报文检查目的地址是否需要进行 NAT。如果需要，就先完成 NAT，然后转发到相应出接口和目的网段。</li>
<li>对报文和目的信息进行安全策略检查，源信息是源接口、源区域和源地址，目的信息是目的接口、目的区域和目的地址。如果有匹配的安全策略，就根据策略进行处理，允许通信就进行转发，拒绝通信就进行丢弃。如果没有匹配的安全策略，就根据默认拒绝的策略丢弃数据。</li>
<li>当报文被允许通信时，防火墙的会话表中就会生成相应的会话信息。</li>
</ol>
<h2 id="会话的生存时间"><a href="#会话的生存时间" class="headerlink" title="会话的生存时间"></a>会话的生存时间</h2><p>自动生成的会话表信息，是有一定的生存时间。会话建立后，一段时间内一直没有进行通信，防火墙会删除生存时间到期的会话表项。如果长期保留会话表项，这些会话信息可能会被恶意攻击。同时，会话表是会占用防火墙资源，防火墙的会话表项的数量也是有限的，长期保留闲置的会话，会影响新会话的生成。</p>
<p>会话时间可以根据协议的不同，分别进行设置。</p>
<p>TCP 的话，会话的超时时间通常是 30 分钟到 1 小时，UDP 是 30 秒。比如，Telnet 连接在防火墙上建立会话后，如果在 1 个小时内没有任何数据通信，防火墙会自动删除这个会话表项。客户端无法再次使用这个 Telnet 会话了。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-13.png" class="">

<h2 id="会话终止处理"><a href="#会话终止处理" class="headerlink" title="会话终止处理"></a>会话终止处理</h2><p>客户端完成数据传输后，发送 FIN 消息，即使用 FIN 标志位的 TCP 数据段。</p>
<p>服务器收到 FIN 消息后，在回复消息中，使用 FIN 和 ACK 标志位，并将 ACK 编号设置为“接收的 Seq 编号 + 1 ” 。</p>
<p>客户端相同处理方式，在回复消息中，使用 ACK 标志位，并将 ACK 编号设置为“接收的 Seq 编号 + 1 ” 。</p>
<p>如果客户端或服务器在连接过程发生故障，只有一方是侦听状态，这叫做半侦听或半关闭。如果通信恢复，接收到故障前的数据段，那么会回复 RST 消息，强制终止 TCP 连接。</p>
<p>当防火墙收到 FIN 或 RST 消息时，会启动一个 30 秒的定时器。即使 FIN → FIN-ACK → ACK 的终止过程没完成，防火墙也会强制删除会话表项。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-14.png" class="">

<h2 id="UDP-数据流的管理"><a href="#UDP-数据流的管理" class="headerlink" title="UDP 数据流的管理"></a>UDP 数据流的管理</h2><p>UDP 不需要像 TCP 一样 3 次握手，客户端和服务器直接使用应用程序的 UDP 数据进行交互。</p>
<p>UDP 数据流是指源 IP 地址、源端口号、目的 IP 地址和目的端口号这 4 个参数都相同的一系列 UDP 数据。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-15.png" class="">

<p>DNS 和 SNMP 这类应用程序，只需要 1 个 UDP 数据，就能构成 1 个数据流。</p>
<p>音频和视频使用的 RTP，就需要多个 UDP 数据，来构成 1 个数据流。</p>
<h2 id="管理-ICMP-和-IP-数据流"><a href="#管理-ICMP-和-IP-数据流" class="headerlink" title="管理 ICMP 和 IP 数据流"></a>管理 ICMP 和 IP 数据流</h2><p>像 ICMP 这类没有端口号的协议，是直接根据 IP 头部的协议号来生成会话。</p>
<p>防火墙通过识别 ICMP 不同的请求消息和对应的响应消息，来判断这些消息序列是否属于同一个会话。</p>


<h2 id="会话同步"><a href="#会话同步" class="headerlink" title="会话同步"></a>会话同步</h2><p>通常两台防火墙会使用主备方式的冗余结构，对主防火墙和备防火墙的会话信息进行同步。主防火墙负责建立用户通信的会话，并把会话信息记录到会话表中，同时将信息转发到备防火墙。</p>
<h2 id="会话管理有什么防御功能？"><a href="#会话管理有什么防御功能？" class="headerlink" title="会话管理有什么防御功能？"></a>会话管理有什么防御功能？</h2><p>防火墙可以通过限制会话数量，能够防范 DoS 攻击，还能控制防火墙的负载，提高防火墙的性能。</p>
<p>防火墙可以以 TCP SYN 、UDP 、ICMP 等协议为单位，通过指定源与目的的组合方式，来限制这类会话的数目。</p>
<h3 id="分组结构解析"><a href="#分组结构解析" class="headerlink" title="分组结构解析"></a>分组结构解析</h3><p>为了防止非法报文的流入和流出，防火墙会对报文的头部和数据进行解析。常见的有：IP 头部解析、TCP 头部解析、UDP 头部解析。</p>
<h4 id="IP-头部解析"><a href="#IP-头部解析" class="headerlink" title="IP 头部解析"></a>IP 头部解析</h4><img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-17.png" class="">

<p>数据帧和 IPv4 头部的解析内容如下：</p>
<p>以太网类型与 IP 版本：以太网数据帧头部的类型字段为 0x0800 时表示 IPv4 ，同时 IPv4 头部的版本也是 4 。类型字段为 0x86DD 时表示 IPv6 ，IP 头部的版本也是 6 。</p>
<p>IP 头部：确认数据是否完整，并检查报文长度与实际长度是否一致。</p>
<p>IP 协议号、TTL ：检查字段值，如果值为 0 就丢弃报文。</p>
<p>源地址、目的地址：确认是否存在 LAND attack 。</p>
<p>数据总长度：确认是否存在 ping of death 攻击。</p>
<p>标志位、分片偏移：丢弃无法进行分片的报文。</p>
<p>可选项：丢弃无用可选项的报文。</p>
<h4 id="TCP-头部解析"><a href="#TCP-头部解析" class="headerlink" title="TCP 头部解析"></a>TCP 头部解析</h4><img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-18.png" class="">

<p>TCP 头部的解析内容如下：</p>
<p>TCP 头部：确认各个字段是否完整、是否有被中途截断。</p>
<p>数据偏移：确认数据偏移字段的值是否是 5 以下，TCP 头部长度最小是 5 字符 &#x3D; 20 字节。</p>
<p>校验和：确认校验和是否错误。</p>
<p>端口号：确认源端口号和目的端口号是否为 0 。</p>
<p>控制位：检查 SYN 、ACK 等字段是否存在组合不正确的情况。</p>
<h4 id="UDP-头部解析"><a href="#UDP-头部解析" class="headerlink" title="UDP 头部解析"></a>UDP 头部解析</h4><img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/2-19.png" class="">

<p>UDP 头部的解析内容如下：</p>
<p>UDP 头部：确认各个字段是否完整、是否有被中途截断。</p>
<p>校验和：确认校验和是否错误。</p>
<h1 id="安全区域"><a href="#安全区域" class="headerlink" title="安全区域"></a>安全区域</h1><p>防火墙有安全区域的概念。防火墙的物理接口和逻辑接口会分配到不同的区域中，也就是将防火墙的网段分别划分到不同的区域中。一个网络接口只能属于一个区域。</p>
<p>在同一个区域内，可以自由进行通信，但是跨区域通信，必须符合安全策略才行。当然，防火墙也可以设置安全策略，根据源或目的地址等条件，判断在同一区域内能否允许通信。</p>
<p>一个安全区域可以说就是若干个接口的集合，一个安全区域里面的接口具有相同的安全属性。</p>
<p>如下图所示：防火墙把不同的接口分成3个安全区域，出口区为<code>untrust</code>区域，内网区分为<code>trust</code>区和<code>DMZ</code>区。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/6.png" class="">

<h2 id="默认安全区域"><a href="#默认安全区域" class="headerlink" title="默认安全区域"></a>默认安全区域</h2><p>防火墙划分了 4 个默认的安全区域：</p>
<table>
<thead>
<tr>
<th align="center">安全区域</th>
<th align="center">说明</th>
<th align="center">优先级</th>
</tr>
</thead>
<tbody><tr>
<td align="center">受信区域（<code>trust</code>）</td>
<td align="center">通常将内网终端用户所在区域划分为<code>trust</code>区域</td>
<td align="center">85</td>
</tr>
<tr>
<td align="center">非受信区域（<code>untrust</code>）</td>
<td align="center">通常将<code>Internet</code>等不安全的网络划分为<code>untrust</code>区域</td>
<td align="center">5</td>
</tr>
<tr>
<td align="center">非军事化区域（<code>dmz</code>）</td>
<td align="center">通常将内网服务器所在区域划分为<code>DMZ</code>区域</td>
<td align="center">50</td>
</tr>
<tr>
<td align="center">本地区域（<code>local</code>）</td>
<td align="center">设备本身，包括设备的各接口本身</td>
<td align="center">100</td>
</tr>
</tbody></table>
<p>默认的安全区域不能够删除，每个安全区域都设置了固定的优先级。优先级值越大，表示优先级越高。</p>
<p>除了这四个域之外，用户也可以根据自己的需求创建自定义域。自定义的域的优先级是可以自己调节的。</p>
<h1 id="安全策略"><a href="#安全策略" class="headerlink" title="安全策略"></a>安全策略</h1><p>防火墙的主要功能是访问控制，也就是判断特定源和特定目的之间是否允许进行特定的通信。访问控制是通过规则来实现，每一条规则都指定了源、目的和通信内容等信息。这些访问控制规则的集合，在路由器中，叫做访问控制列表，而在防火墙中，叫做安全策略或安全规则。</p>
<h2 id="什么是安全策略"><a href="#什么是安全策略" class="headerlink" title="什么是安全策略"></a>什么是安全策略</h2><p>安全策略是防火墙中对流量转发、以及对流量中的内容进行安全一体化检测的策略。</p>
<p>当防火墙收到流量后，会对流量的属性（包括五元组、用户、时间段等）进行识别，从而和安全策略进行匹配，如果能够匹配上，则执行相应的动作。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/8.png" class="">

<p>如上图所示：PC 访问<code>internet</code>，匹配到防火墙安全策略，动作为<code>permit</code>，因此流量可以通过防火墙。如果动作为<code>deny</code>，则流量不能够通过防火墙。</p>
<h2 id="防火墙的安全策略"><a href="#防火墙的安全策略" class="headerlink" title="防火墙的安全策略"></a>防火墙的安全策略</h2><p>防火墙的安全策略以区域作为对象，还可以以应用程序名称和用户名称等信息作为对象。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/21.png" class="">

<p>举个栗子：在上图的安全策略中，<code>192.168.2.1</code>从信任区域向不信任区域的 80 端口通信时，防火墙首先执行第 1 条安全策略，发现源地址不匹配，不执行<code>Allow</code>。接着执行第 2 条安全策略，发现地址和端口匹配，执行<code>Deny</code>，也就是拒绝通信。防火墙的安全策略从上往下依次执行的行为，也叫做安全策略查找（<code>policy lookup</code>）。</p>
<p><code>Any</code>表示任何值都与策略匹配。如果是安全策略中，出现未定义的通信，比如从信任区到 DMZ 区域的通信，防火墙默认执行拒绝，这个策略叫做 “ 默认拒绝 ”（<code>implicit deny</code>）。</p>
<p>如果需要在防火墙没有匹配的情况下，执行<code>Allow</code>，可以在安全策略的最后一行设置对象为<code>Any</code>，行为为<code>Allow</code>的策略。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/22.png" class="">

<p>当然，防火墙的安全策略是会有上限，上限由产品规格决定。而且当表项越多时，设备性能也会随之下降。</p>
<h2 id="安全策略组成"><a href="#安全策略组成" class="headerlink" title="安全策略组成"></a>安全策略组成</h2><p>安全策略由匹配条件、动作、安全配置文件组成。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/9.png" class="">

<ol>
<li>匹配条件：<br>匹配条件包括五元组（源地址、目的地址、源端口、目的端口、协议）、VLAN、源安全区域、目的安全区域、用户、时间段等。</li>
<li>动作：动作包括允许和禁止。<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/10.png" class="">
如果动作为“允许”：</li>
</ol>
<ul>
<li>如果没有配置内容安全检测，则允许流量通过。</li>
<li>如果配置内容安全检测，最终根据内容安全检测的结论来判断是否对流量进行放行。<br>禁止：表示拒绝符合条件的流量通过。</li>
<li>如果动作为“禁止”，防火墙不仅可以将报文丢弃；</li>
<li>还可以针对不同的报文类型选择发送对应的反馈报文。发起连接请求的客户端&#x2F;服务器收到防火墙发送的阻断报文后，可以快速结束会话并让用户感知到请求被阻断。</li>
</ul>
<ol start="3">
<li>安全配置文件：内容安全检测包括反病毒、入侵防御等，它是通过在安全策略中引用安全配置文件实现的。</li>
</ol>
<ul>
<li>如果其中一个安全配置文件阻断该流量，则防火墙阻断该流量。</li>
<li>如果所有的安全配置文件都允许该流量转发，则防火墙允许该流量转发。</li>
</ul>
<h2 id="安全策略匹配过程"><a href="#安全策略匹配过程" class="headerlink" title="安全策略匹配过程"></a>安全策略匹配过程</h2><p>防火墙的安全策略一般配置很多条，如果都可以匹配应该优先匹配哪一条呢?</p>
<p>安全策略的匹配按照策略列表顺序执行，从上往下逐条匹配，如果匹配了某条策略，将不再往下匹配。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/11.png" class="">

<p>因此，配置安全策略的顺序很重要，需要优先配置精确的安全策略，然后再配置粗略的安全策略。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/12.png" class="">

<p>系统默认存在一条缺省安全策略<code>default</code>。</p>
<p>缺省安全策略位于策略列表的最底部，优先级最低，所有匹配条件均为<code>any</code>，动作默认为禁止。如果所有配置的策略都未匹配，则将匹配缺省安全策略<code>default</code>。</p>
<h2 id="会话表"><a href="#会话表" class="headerlink" title="会话表"></a>会话表</h2><p>会话表用来记录 TCP、UDP、ICMP 等协议连接状态的表项，是防火墙转发报文的重要依据；</p>
<p>那么什么是基于连接状态转发报文呢？防火墙基于“状态”转发报文：</p>
<ol>
<li>只对首包或者少量报文进行检测然后确认一个连接状态；（会话表）</li>
<li>后续大量的报文根据连接状态进行控制；</li>
</ol>
<p>会话表就记录了大量的连接状态；这种机制大大的提升了防火墙的检测和转发效率。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/13.png" class="">

<p>如上图所示：客户端 PC1 访问服务器 PC2，PC1 向 PC2 发起 HTTP 连接；</p>
<ol>
<li>PC1发送报文；</li>
<li>首包达到防火墙，创建会话表项（如下）；防火墙会话表中标示出<code>http</code>协议和连接信息，并识别出此流量在公共路由表中被转发；<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http VPN: public-&gt;public 192.168.1.254:10000-&gt;10.10.1.254:80</span><br></pre></td></tr></table></figure></li>
<li>防火墙放行报文；</li>
<li>PC2 回复报文；</li>
<li>回复报文匹配防火墙会话；</li>
<li>防火墙转发报文；</li>
</ol>
<h3 id="会话表的创建"><a href="#会话表的创建" class="headerlink" title="会话表的创建"></a>会话表的创建</h3><p>防火墙在开启状态检测情况下，只有首包会创建会话表项，后续报文匹配会话表即可转发。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/14.png" class="">

<h3 id="会话表老化时间"><a href="#会话表老化时间" class="headerlink" title="会话表老化时间"></a>会话表老化时间</h3><p>对于一个已经建立的会话表表项，只有当它不断被报文匹配才有存在的必要。如果长时间没有报文匹配，则说明可能通信双方已经断开了连接，不再需要该条会话表项了。</p>
<p>为了节约系统资源，系统会在一条表项连续未被匹配一段时间后，将其删除，即会话表项已经老化。</p>
<h3 id="长连接"><a href="#长连接" class="headerlink" title="长连接"></a>长连接</h3><p>对于某些特殊业务中，一条会话的两个连续报文可能间隔时间很长。</p>
<p>例如：</p>
<ul>
<li>用户通过 FTP 下载大文件，需要间隔很长时间才会在控制通道继续发送控制报文。</li>
<li>用户需要查询数据库服务器上的数据，这些查询操作的时间间隔远大于 TCP 的会话老化时间。</li>
</ul>
<p>如果只靠延长这些业务所属协议的老化时间来解决这个问题，会导致一些同样属于这个协议，但是其实并不需要这么长的老化时间的会话长时间不能得到老化。</p>
<p>这会导致系统资源被大量占用，性能下降，甚至无法再为其他业务建立会话。所以必须缩小延长老化时间的流量范围。</p>
<p>长连接功能可以解决这一问题。长连接功能可以为这些特殊流量设定超长的老化时间。</p>
<h2 id="Server-map"><a href="#Server-map" class="headerlink" title="Server-map"></a>Server-map</h2><h3 id="为什么会出现server-map表？"><a href="#为什么会出现server-map表？" class="headerlink" title="为什么会出现server-map表？"></a>为什么会出现server-map表？</h3><p>由于会话表对哪些报文属于同一条流量的标准过于严格，会导致一些特殊协议不能正确匹配会话表。</p>
<p>Server-map表可以解决这一问题。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/15.png" class="">

<p>例如使用 FTP 协议的<code>port</code>方式传输文件时：</p>
<ul>
<li>既需要客户端主动向服务器端发起控制连接；</li>
<li>又需要服务器端主动向客户端发起服务器数据连接；</li>
</ul>
<p>如果设备上配置的安全策略为允许单方向上报文主动通过，则 FTP 文件传输不能成功。</p>
<h3 id="server-map表原理"><a href="#server-map表原理" class="headerlink" title="server-map表原理"></a>server-map表原理</h3><p>通常情况下，如果在设备上配置严格的安全策略，那么设备将只允许内网用户单方向主动访问外网。</p>
<p>为了解决这一类问题，防火墙引入了<code>Server-map</code>表，<code>Server-map</code>用于存放一种映射关系。</p>
<ul>
<li>这种映射关系可以是控制数据协商出来的数据连接关系；</li>
<li>也可以是配置 NAT 中的地址映射关系；</li>
</ul>
<p>使得外部网络能透过设备主动访问内部网络。</p>
<p>生成<code>Server-map</code>表之后，如果一个数据连接匹配了<code>Server-map</code>表项，那么就能够被设备正常转发，并在匹配<code>Server-map</code>表后创建会话，保证后续报文能够按照会话表转发。</p>
<h3 id="server-map表报文转发过程"><a href="#server-map表报文转发过程" class="headerlink" title="server-map表报文转发过程"></a>server-map表报文转发过程</h3><p>防火墙收到报文后，如果没有命中会话表，防火墙则进入首包处理流程，查询是否命中<code>server-map</code>表。</p>
<ul>
<li>如果命中，则生成会话表，转发报文；</li>
<li>如果没有命中，则执行其他包处理流程。</li>
</ul>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/16.png" class="">

<h1 id="防火墙应用场景"><a href="#防火墙应用场景" class="headerlink" title="防火墙应用场景"></a>防火墙应用场景</h1><h3 id="1、企业边界防护"><a href="#1、企业边界防护" class="headerlink" title="1、企业边界防护"></a>1、企业边界防护</h3><p>如下图所示，企业内网业务部署在<code>trust</code>区，服务器部署在 DMZ。</p>
<ul>
<li>企业内网访问<code>internet</code>时经过防火墙，防火墙控制内外网流量，进行安全控制；</li>
<li>外网用户访问服务器时经过防火墙，对内网服务器进行保护；</li>
</ul>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/3.png" class="">

<h3 id="2、内网安全隔离"><a href="#2、内网安全隔离" class="headerlink" title="2、内网安全隔离"></a>2、内网安全隔离</h3><p>如下图所示：公司分为市场部、生产部，财经部，研发部，不同部分之间互访经过防火墙。通过防火墙进行安全控制。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/4.png" class="">

<h3 id="3、数据中心边界防护"><a href="#3、数据中心边界防护" class="headerlink" title="3、数据中心边界防护"></a>3、数据中心边界防护</h3><p>数据中心网络访问<code>internet</code>时，需要经过防火墙进行安全控制，对内网业务进行安全保护。</p>
<img src="/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/5.png" class="">
 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          打赏
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2023/04/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%98%B2%E7%81%AB%E5%A2%99/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/04/13/%E5%89%8D%E7%AB%AF/js/Three.js/Three.js%E5%85%89%E6%BA%90/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            (no title)
          
        </div>
      </a>
    
    
      <a href="/2023/04/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E4%BA%8C%E5%B1%82%E4%BA%A4%E6%8D%A2%E6%9C%BA/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">二层交换机</div>
      </a>
    
  </nav>

  
   
  
    
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2017-2023
        <i class="ri-heart-fill heart_icon"></i> WSQ
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="学海无涯"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>
 
<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>